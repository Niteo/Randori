<!DOCTYPE html>
<style>
  #state {
      padding-top: 1em;
  }
</style>
<head><title>Randori: Poll Editor</title></head>
<body>
<h1 id="title">Poll Editor</h1>
<div id="container">
  <button onclick="import_poll()">Import poll...</button>
  <button onclick="export_poll()">Export poll...</button>
  <div id="questions">
  <h2>Root Questions</h2>
    <ul id="root_list">
    </ul>
    <button onclick="newQuestionUI()">Add question</button>
    </div>
    <div id="follow-ups">
      <h2>Follow-ups</h2>
      <ul id="follow-ups-list"></ul>
      <button onclick="newFollowUpUI()">Add follow-up question</button>
    </div>

</div>

<script>

var poll = {"children": [
{"answers": ["B+", "AB+", "O-", "A-", "Other"],
   "probability": ["1/5", "1/5", "1/5", "1/5", "1/5"],
   "qid": 1,
   "question": "Specify..."},
  {"answers": ["B-", "AB-"],
   "probability": ["3/4", "1/4"],
   "qid": 2,
   "question": "Specify further..."}],
 "paths": [[0, "Other", 1], [1, "Other", 2]],
 "roots": [{"answers": ["O+", "A+", "Other"],
   "probability": ["1/3", "1/3", "1/3"],
   "qid": 0,
   "truth": "1/2",
   "question": "Blood type?"}, 
   {"answers": ["A", "B", "C"],
   "probability": ["1/3", "1/3", "1/3"],
   "qid": 4,
   "truth": "3/4",
   "question": "Q2?"},
   {"answers": ["1", "2"],
   "probability": ["1/2", "1/2"],
   "qid": 3,   
   "truth": "1/3",
   "question": "1 or 2?"}],
 "order": [0, 4, 3]
}

var counter = 1;
var follow_up_counter = 1;
var paths = [];
var roots = [];
var children = [];

var input = document.createElement('input');
input.type = 'file';

input.onchange = e => { 

   // getting a hold of the file reference
   var file = e.target.files[0]; 

   // setting up the reader
   var reader = new FileReader();
   reader.readAsText(file,'UTF-8');

   // here we tell the reader what to do when it's done reading...
   reader.onload = readerEvent => {
      var content = readerEvent.target.result; // this is the content!
      var parsed = JSON.parse(content)
      fromJSON(parsed); 
   }

}


function toJSON(){
  let output = {};
  let order = [];

  //Populate data from UI


  // Assign
  output['children'] = children;
  output['roots'] = roots;
  output['paths'] = paths;
  output['order'] = order;

  console.log(output);

  return JSON.stringify(output);
}

function fromJSON(content){
  let max = Number.MIN_VALUE;
  let fmax = Number.MIN_VALUE;
  let order = [];
  children = [];
  roots = [];
  paths = [];

  children = content['children'];
  roots = content['roots'];
  paths = content['paths'];
  order = content['order'];



  // Populate UI
  roots.forEach(function (root){
    let qid = root['qid'];
    createQuestionUI(root['question'], root['answers'], root['probability'], qid);
    if(qid > max){
      max = qid;
    }
  });

  let count = 1;
  order.forEach(function (qid){
    document.getElementById("question"+qid+"order").value = count;
    count++;

  });

  children.forEach(function (child){
    //Find path(s)
    let parents = [];
    let fqid = child['qid'];

    paths.forEach(function (path){
      if(path[2]==fqid){
        parents.push((path[0]),path[1]);
      }
    });
    createFollowUpUI(child['question'], child['answers'], child['probability'],fqid, parents, parents);

    if(fqid > fmax){
      fmax = fqid;
    }
  });



  counter = max;
  follow_up_counter = fmax;
}




// Graphical representation
function newQuestionUI() {
  createQuestionUI("", "", "", counter);
  counter++;

}

// Graphical representation
function newFollowUpUI() {
  createFollowUpUI("","","","", "", follow_up_counter);
  follow_up_counter++;

}

// Logic representation
function createQuestion(q, a, prob, i){
  let question = {};
  question['question'] = q;
  question['qid'] = i;
  question['answers'] = a;
  question['probability'] = prob;


  return question;
}

// Logical representation
function createPath(p, pa, c){
  paths.push([p,pa,c]);
}

// Logic representation
function createFollowUp(q, a, prob, i, pid, pa){
  let question = createQuestion(q, a, prob, i);
  createPath(pid,pa,i);
}

// createQuestionUI(Question string, Answers string, Probabilities string, Id int)
function createQuestionUI(q, a, prob, id){
  var question = document.createElement("input");
  var answers = document.createElement("textarea");
  var probabilities = document.createElement("textarea");
  var elem = document.createElement("li");
  var question_label = document.createElement("label");
  var answer_label = document.createElement("label");
  var id_label = document.createElement("label");
  var remove_button = document.createElement("button");
  var order = document.createElement("input")

  question_label.innerHTML = "Question: ";
  answer_label.innerHTML = "Answer |  Fraction: "
  id_label.innerHTML = "id=Q"+id;
  remove_button.innerHTML = "Delete";

  remove_button.id = "remove"+id;

  elem.id = "question"+id;
  question.placeholder = "Question "+id;
  question.type = "text";
  question.id = "question"+id+"textarea";
  answers.placeholder = "One answer alternative per row";
  answers.id = "answers"+id;
  probabilities.placeholder = "Proability to choose corresponding answer";
  probabilities.id = "probabilities"+id;
  order.type = "number";
  order.placeholder = "order";
  order.id = "question"+id+"order";

  question.value=q;
  answers.value=a;
  probabilities.value=prob;

  remove_button.onclick = function remove() {
    roots.removeChild(elem);
    }

  elem.appendChild(order);
  elem.appendChild(id_label);
  elem.appendChild(question_label); 
  elem.appendChild(question);
  elem.appendChild(answer_label);
  elem.appendChild(answers);
  elem.appendChild(probabilities);
  elem.appendChild(remove_button);


  var roots = document.getElementById("root_list");
  roots.appendChild(elem);
}

// createFollowUpUI(Question string, Answer string, Probabilities string, Parent id, Parent answer string)
function createFollowUpUI(q, a, prob, id, p, pa) {
  var parent = document.createElement("input");
  var alternative = document.createElement("input");
  var question = document.createElement("input");
  var answers = document.createElement("textarea");
  var probabilities = document.createElement("textarea");
  var elem = document.createElement("li");
  var question_label = document.createElement("label");
  var answer_label = document.createElement("label");
  var id_label = document.createElement("label");
  var remove_button = document.createElement("button");

  question_label.innerHTML = "Question: ";
  answer_label.innerHTML = "Answer |  Fraction: "
  id_label.innerHTML = "id=F"+id;
  remove_button.innerHTML = "Delete";

  remove_button.id = "removeF"+id;

  elem.id = "question"+id;

  parent.type = "text";
  parent.placeholder = "Parent question id";
  alternative.type = "text";
  alternative.placeholder = "trigger (answer)"

  question.placeholder = "Follow-up ";
  question.type = "text";
  question.id = "question"+id+"textarea";
  answers.placeholder = "One answer alternative per row";
  answers.id = "answers"+id;
  probabilities.placeholder = "Proability to choose corresponding answer";
  probabilities.id = "probabilities"+id;

  question.value=q;
  answers.value=a;
  probabilities.value=prob;
  parent.value=p;
  alternative.value=pa;


  remove_button.onclick = function remove() {
    followups.removeChild(elem);
  }

  elem.appendChild(id_label);
  elem.appendChild(parent);
  elem.appendChild(alternative);
  elem.appendChild(question_label); 
  elem.appendChild(question);
  elem.appendChild(answer_label);
  elem.appendChild(answers);
  elem.appendChild(probabilities);
  elem.appendChild(remove_button);


  var followups = document.getElementById("follow-ups-list");
  followups.appendChild(elem);

}

function export_poll() {
  let name = prompt("Enter a file name: ", "poll.json");
  let contentType = "application/json;charset=utf-8;";
  let a = document.createElement('a');
  a.download = name;
  a.href = 'data:' + contentType + ',' + encodeURIComponent(toJSON());
  a.target = '_blank';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a)
}

function import_poll() {
  cleanGUI();
  input.click();
}

function cleanGUI(){

  
  let questions = document.getElementById("root_list");
  let followups = document.getElementById("follow-ups-list");

  let buttons = questions.querySelectorAll("button");
  let buttons_follow = followups.querySelectorAll("button");

  buttons.forEach(function (button) {
    button.click();
  });

  buttons_follow.forEach(function (button) {
    button.click();
  });

}

</script>
</body>
</html>
