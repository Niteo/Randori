<!DOCTYPE html>
<style>
  #state {
      padding-top: 1em;
  }


 /* The switch - the box around the slider */
.switch {
  position: relative;
  display: inline-block;
  width: 60px;
  height: 34px;
  bottom: 9px;
}

/* Hide default HTML checkbox */
.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

/* The slider */
.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  -webkit-transition: .4s;
  transition: .4s;
}

.slider:before {
  position: absolute;
  content: "";
  height: 26px;
  width: 26px;
  left: 4px;
  bottom: 4px;
  background-color: white;
  -webkit-transition: .4s;
  transition: .4s;
}

input:checked + .slider {
  background-color: darkseagreen;
}

input + .slider {
  background-color: lightseagreen;
}

input:focus + .slider {
  box-shadow: 0 0 1px darkseagreen;
}

input:checked + .slider:before {
  -webkit-transform: translateX(26px);
  -ms-transform: translateX(26px);
  transform: translateX(26px);
}

/* Rounded sliders */
.slider.round {
  border-radius: 34px;
}

.slider.round:before {
  border-radius: 50%;
}




</style>
<head><title>Randori: Poll Editor</title></head>
<nav>
  <div style="text-align: center"><button onclick="import_poll()" style="border-radius: 12px; border:none; padding: 7px 17px; background-color:lightgrey;">Import poll...</button>
  <button onclick="export_poll()" style="border-radius: 12px; border:none; padding: 7px 17px; background-color:lightgrey;">Export poll...</button>
</div>
    <div style="margin-top: 20px;text-align: center"><span style="font-size:24px">Edit</span>
      <!-- Rounded switch -->
      <label class="switch">
        <input type="checkbox" id="toggler" onchange="toggle()">
        <span class="slider round"></span>
      </label> <span style="font-size:24px">Explore</span>
  </div>
</nav>
<body>
<hr>
<div id="container">
  <div id="questions" style="text-align: center;">
  <h2>Root Questions</h2>
    <div id="root_list">
    </div>
    <div style="margin-top: 20px;">
      <button onclick="newQuestionUI()" style="border-radius: 12px; border:none; padding: 7px 17px; background-color:lightgrey;">Add question</button>
    </div>
    </div>
    <div id="follow-ups" style="text-align: center">
      <h2>Follow-ups</h2>
      <div id="follow-ups-list" style="text-align: center"></div>
      <div style="margin-top: 20px;">
        <button onclick="newFollowUpUI()" style="border-radius: 12px; border:none; padding: 7px 17px; background-color:lightgrey;">Add follow-up question</button>
      </div>
    </div>
    
</div>

<div id="explorer" hidden="true" style="text-align: center">
  <div id="equations" style="text-align: center"> </div>
  <div><h2>Pick a Question</h2></div>
<form>
  <select id="data-list" onchange="chosen()">
     <option value="placeholder"></option> 
  </select>
</form>
<div id="subtree-container" style="text-align: center">
</div>
</div>

<script src="https://unpkg.com/mathjs@7.2.0/dist/math.min.js"></script>


<script>

var poll = {"children": [
{"answers": ["B+", "AB+", "O-", "A-", "Other"],
   "probability": ["1/5", "1/5", "1/5", "1/5", "1/5"],
   "qid": 1,
   "question": "Specify..."},
  {"answers": ["B-", "AB-"],
   "probability": ["3/4", "1/4"],
   "qid": 2,
   "question": "Specify further..."}],
 "paths": [[0, "Other", 1], [1, "Other", 2]],
 "roots": [{"answers": ["O+", "A+", "Other"],
   "probability": ["1/3", "1/3", "1/3"],
   "qid": 0,
   "truth": "1/2",
   "question": "Blood type?"}, 
   {"answers": ["A", "B", "C"],
   "probability": ["1/3", "1/3", "1/3"],
   "qid": 4,
   "truth": "3/4",
   "question": "Q2?"},
   {"answers": ["1", "2"],
   "probability": ["1/2", "1/2"],
   "qid": 3,   
   "truth": "1/3",
   "question": "1 or 2?"}],
 "order": [0, 4, 3]
}

var counter = 1;
var follow_up_counter = 1;
var paths = [];
var roots = [];
var children = [];

var lookup = {};
var data = undefined;

var input = document.createElement('input');
input.type = 'file';

input.onchange = e => { 

   // getting a hold of the file reference
   var file = e.target.files[0]; 

   // setting up the reader
   var reader = new FileReader();
   reader.readAsText(file,'UTF-8');

   // here we tell the reader what to do when it's done reading...
   reader.onload = readerEvent => {
      var content = readerEvent.target.result; // this is the content!
      var parsed = JSON.parse(content)
      fromJSON(parsed); 
   }

}

function toggle(){
  let elem = document.getElementById("toggler");

  // Explore mode
  if(elem.checked){
    data = toJSON();
    lookup = getLookup();
    explorerGUI();

  } else{ //Edit mode
    editGUI();

    if(data != undefined){
      fromJSON(JSON.parse(data));
      lookup = getLookup();
    }
  }
}

function chosen(){
  let elem = document.getElementById("data-list");

  if(elem && elem!="placeholder"){
    console.log(elem.value);
    let qid = elem.value;

    let root = undefined;

    roots.forEach(function (r){
      if(r['qid']==qid){
        root = r;
      }
    });

    let parent_div = document.getElementById("subtree-container");
    parent_div.innerHTML = "<br><h3>True/Random answers:</hr><br>"; 

    
    let questions = [root];
    let coinflip = document.createElement("input");
    let ep = document.createElement("label");
    coinflip.type = "range";
    ep.innerHTML = "<br><h3>Epsilon: </h3>";

    parent_div.appendChild(coinflip);
    parent_div.appendChild(ep);

    // Find all follow-ups qids, recursively!
    recurse(qid, questions);

    questions.forEach(function (question){
      let i = 0;
      question['answers'].forEach(function (answer){
        let div = document.createElement("div");
        let label = document.createElement("label");
        let prob = document.createElement("input");
        let a_label = document.createElement("label");
        let b_label = document.createElement("label");
        let alpha = document.createElement("input");
        let beta = document.createElement("input");

        label.innerHTML = "Pr["+answer+"] = Pr[&not random] + Pr["+answer+"| random], Node weight = ";
        prob.value = question['probability'][i];
        prob.placeholder = "n/d"

        alpha.type = "number";
        beta.type = "number";
        alpha.max = 100;
        alpha.min = 0;
        beta.max = 100;
        beta.min = 0;

        beta.title = "Lower is better";
        alpha.title = "Lower is better";
        a_label.title = "Error is bounded by alpha";
        b_label.title = "Probability of bound not holding is beta";
        prob.title = "Fraction: n/d";

        a_label.innerHTML = "alpha =";
        b_label.innerHTML = "beta =";


        div.appendChild(label);
        div.appendChild(prob);
        div.appendChild(a_label);
        div.appendChild(alpha);
        div.appendChild(b_label);
        div.appendChild(beta);
        parent_div.appendChild(div);

        i++;
      });
    });




  }
}

function getLookup(){
  let lookup = {};
  roots.forEach(function (question){
      lookup[question['qid']] = question;
  });

  children.forEach(function (question){
      lookup[question['qid']] = question;
  });

  return lookup;
}

// Traverse and decorate JSON
function recurse(qid, order) {
  paths.forEach(function(d, i){
    let source = d[0];
    let alt = d[1];
    let target = d[2];
    let prefix = alt;
    let parent = lookup[source];
    let parent_index = parent["answers"].indexOf(alt);
    let compound_prob = math.Fraction(parent["probability"][parent_index]);

    parent["to_remove"] = alt;

    if(source==qid){
        let add = lookup[target];
        let parent_prefix = parent["answer_prefix"];
        order.push(add)

        // Continue building string if there is already one
        if(parent_prefix){
            prefix = parent_prefix+alt;
          }

        // Decorate
        add["answer_prefix"] = prefix;
        add["compound_answers"] = add["answers"].map(function (ans) {
                return prefix+ans;
        });

        // Continue with probability from parent answer
        if(parent["compound_probability"]){
          compound_prob = parent["compound_probability"][parent_prefix+alt];
        } 

        // Decorate
        add["compound_probability"] = {};
        add["answers"].forEach(function (answer, index) {
            add["compound_probability"][prefix+answer] = compound_prob.mul(math.Fraction(add["probability"][index]));  
        });

        recurse(target, order);
    }
  });
}



function toJSON(){
  let output = {};
  let order = [];

  let order_to_qid = {};
  roots.forEach(function (root) {
    let qid = root['qid'];
    let order_input = document.getElementById("question"+qid+"order");
    order_to_qid[order_input.value] = qid;
  });

  for(qid in order_to_qid){
    order.push(order_to_qid[qid]);
  }

  //Populate data from UI


  // Assign
  output['children'] = children;
  output['roots'] = roots;
  output['paths'] = paths;
  output['order'] = order;

  return JSON.stringify(output);
}

function fromJSON(content){
  let max = Number.MIN_VALUE;
  let fmax = Number.MIN_VALUE;
  let order = [];
  children = [];
  roots = [];
  paths = [];

  children = content['children'];
  roots = content['roots'];
  paths = content['paths'];
  order = content['order'];



  // Populate UI
  roots.forEach(function (root){
    let qid = root['qid'];
    createQuestionUI(root['question'], root['answers'], root['probability'], qid);
    if(qid > max){
      max = qid;
    }
  });

  let count = 1;
  order.forEach(function (qid){
    document.getElementById("question"+qid+"order").value = count;
    count++;

  });

  children.forEach(function (child){
    //Find path(s)
    let parents = [];
    let fqid = child['qid'];

    paths.forEach(function (path){
      if(path[2]==fqid){
        parents.push((path[0]),path[1]);
      }
    });
    createFollowUpUI(child['question'], child['answers'], child['probability'],fqid, parents[0], parents[1]);

    if(fqid > fmax){
      fmax = fqid;
    }
  });



  counter = max;
  follow_up_counter = fmax;
}




// Graphical representation
function newQuestionUI() {
  createQuestionUI("", "", "", counter);
  counter++;

}

// Graphical representation
function newFollowUpUI() {
  createFollowUpUI("","","",follow_up_counter, "", "");
  follow_up_counter++;

}

// Logic representation
function createQuestion(q, a, prob, i){
  let question = {};
  question['question'] = q;
  question['qid'] = i;
  question['answers'] = a;
  question['probability'] = prob;


  return question;
}

// Logical representation
function createPath(p, pa, c){
  paths.push([p,pa,c]);
}

// Logic representation
function createFollowUp(q, a, prob, i, pid, pa){
  let question = createQuestion(q, a, prob, i);
  createPath(pid,pa,i);
}

// createQuestionUI(Question string, Answers string, Probabilities string, Id int)
function createQuestionUI(q, a, prob, id){
  var container = document.createElement("div");
  var question = document.createElement("input");
  var answers = document.createElement("textarea");
  var probabilities = document.createElement("textarea");
  var elem = document.createElement("li");
  var question_label = document.createElement("label");
  var answer_label = document.createElement("label");
  var id_label = document.createElement("label");
  var remove_button = document.createElement("button");
  var order = document.createElement("input")

  container.style = "border:2px solid lightgrey;padding:20px;margin:5px;border-radius:10px;text-align:center;";

  question_label.innerHTML = "Question: ";
  answer_label.innerHTML = "Answer |  Fraction: "
  id_label.innerHTML = "<b>id:Q"+id+"</b>";
  remove_button.innerHTML = "Delete";

  remove_button.id = "remove"+id;
  remove_button.style = "border-radius: 12px; border:none; padding: 7px 17px; background-color:indianred;color:white;"

  elem.id = "question"+id;
  question.placeholder = "Question "+id;
  question.type = "text";
  question.id = "question"+id+"textarea";
  answers.placeholder = "One answer alternative per row";
  answers.id = "answers"+id;
  answers.placeholder = "One answer alternative per row";
  answers.id = "answers"+id;
  answers.title = "Alternatives separated by comma"
  probabilities.title ="Separated by comma, corresponding to order of alternative";
  probabilities.placeholder = "Proability to choose corresponding answer";
  probabilities.id = "probabilities"+id;
  order.type = "number";
  order.placeholder = "order";
  order.id = "question"+id+"order";

  question.value=q;
  answers.value=a;
  probabilities.value=prob;

  remove_button.onclick = function remove() {
    roots.removeChild(elem);
    }

  container.appendChild(id_label);
  container.appendChild(document.createElement("br"));
  container.appendChild(order);
  container.appendChild(document.createElement("br"));
  container.appendChild(question_label); 
  container.appendChild(question);
  container.appendChild(document.createElement("br"));
  container.appendChild(answer_label);
  container.appendChild(answers);
  container.appendChild(probabilities);
  container.appendChild(document.createElement("br"));
  container.appendChild(remove_button);

  elem.appendChild(container);


  var roots = document.getElementById("root_list");
  roots.appendChild(elem);
}

// createFollowUpUI(Question string, Answer string, Probabilities string, Parent id, Parent answer string)
function createFollowUpUI(q, a, prob, id, p, pa) {
  var elem = document.createElement("div");
  var condition = document.createElement("label");
  var parent = document.createElement("input");
  var alternative = document.createElement("input");
  var question = document.createElement("input");
  var answers = document.createElement("textarea");
  var probabilities = document.createElement("textarea");
  var question_label = document.createElement("label");
  var answer_label = document.createElement("label");
  var id_label = document.createElement("label");
  var remove_button = document.createElement("button");

  elem.style = "border:2px solid lightgrey;padding:20px;margin:5px;border-radius:10px;text-align:center;";

  condition.innerHTML = "Condition/trigger: ";
  question_label.innerHTML = "Question: ";
  answer_label.innerHTML = "Answer |  Fraction: "
  id_label.innerHTML = "<b>id:F"+id+"</b>";
  remove_button.innerHTML = "Delete";

  remove_button.id = "removeF"+id;
  remove_button.style = "border-radius: 12px; border:none; padding: 7px 17px; background-color:indianred;color:white;"

  elem.id = "question"+id;

  parent.type = "text";
  parent.placeholder = "Parent question id";
  alternative.type = "text";
  alternative.placeholder = "trigger (answer)"

  question.placeholder = "Follow-up ";
  question.type = "text";
  question.id = "question"+id+"textarea";
  answers.placeholder = "One answer alternative per row";
  answers.id = "answers"+id;
  answers.title = "Alternatives separated by comma"
  probabilities.placeholder = "Proability to choose corresponding answer";
  probabilities.id = "probabilities"+id;
  probabilities.title ="Separated by comma, corresponding to order of alternatives";

  question.value=q;
  answers.value=a;
  probabilities.value=prob;
  parent.value=p;
  alternative.value=pa;


  remove_button.onclick = function remove() {
    followups.removeChild(elem);
  }

  elem.appendChild(id_label);
  elem.appendChild(document.createElement("br"));
  elem.appendChild(condition);
  elem.appendChild(parent);
  elem.appendChild(alternative);
  elem.appendChild(document.createElement("br"));
  elem.appendChild(question_label); 
  elem.appendChild(question);
  elem.appendChild(document.createElement("br"));
  elem.appendChild(answer_label);
  elem.appendChild(answers);
  elem.appendChild(probabilities);
  elem.appendChild(document.createElement("br"));
  elem.appendChild(remove_button);


  var followups = document.getElementById("follow-ups-list");
  followups.appendChild(elem);

}

function export_poll() {
  let name = prompt("Enter a file name: ", "poll.json");
  let contentType = "application/json;charset=utf-8;";
  let a = document.createElement('a');
  a.download = name;
  a.href = 'data:' + contentType + ',' + encodeURIComponent(toJSON());
  a.target = '_blank';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a)
}

function import_poll() {
  cleanGUI();
  input.click();
}

function cleanGUI(){

  
  let questions = document.getElementById("root_list");
  let followups = document.getElementById("follow-ups-list");

  let buttons = questions.querySelectorAll("button");
  let buttons_follow = followups.querySelectorAll("button");

  buttons.forEach(function (button) {
    button.click();
  });

  buttons_follow.forEach(function (button) {
    button.click();
  });

}

function explorerGUI(){
  cleanGUI();
  let editor = document.getElementById("container");
  editor.hidden=true;

  let explorer = document.getElementById("explorer");
  explorer.hidden=false;

  let equations = document.getElementById("equations");
  equations.innerHTML = "";
  let chernoff = document.createElement("label");
  chernoff.innerHTML = "<h2> Chernoff bound:<br> Pr[error<= alpha] >= beta, <br> where error=Pr[&not answer|random]<br> </h2><hr>";
  equations.appendChild(chernoff);

  //Populate GUI with subtrees
  let datalist = document.getElementById("data-list");

  roots.forEach(function (root){
    let opt = document.createElement("option");
    opt.value = root['qid'];
    opt.innerHTML = root['question'];
    datalist.appendChild(opt);
  });
}

function editGUI(){
  cleanGUI();
  let element = document.getElementById("container");
  element.hidden=false;
  let explorer = document.getElementById("explorer");
  explorer.hidden=true;
}

</script>
</body>
</html>
